{% extends 'irrigation/base.html' %}
{% load static %}

{% block title %}Sensor Data Visualization{% endblock %}

{% block extra_head %}
<style>
    .visualization-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-title {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 30px;
        text-align: center;
        color: #1f2937;
        background: linear-gradient(135deg, #059669 0%, #065f46 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        padding: 15px 0;
    }

    .control-panel {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .control-section {
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: block;
    }

    .chart-type-select, .time-range-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #d1d5db;
        border-radius: 10px;
        background: white;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23059669'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 16px;
    }

    .chart-type-select:focus, .time-range-select:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .checkbox-item:hover {
        border-color: #059669;
        background: #f0fdf4;
        transform: translateY(-2px);
    }

    .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        accent-color: #059669;
    }

    .checkbox-label {
        font-weight: 500;
        color: #374151;
    }

    .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
        background: linear-gradient(135deg, #047857, #065f46);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-outline {
        background: transparent;
        border: 2px solid #d1d5db;
        color: #6b7280;
        font-weight: 600;
    }

    .btn-outline:hover {
        border-color: #059669;
        color: #059669;
        background: rgba(5, 150, 105, 0.05);
    }

    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        position: relative;
        min-height: 450px;
    }

    .loading-indicator {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        z-index: 10;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .loading-indicator.visible {
        opacity: 1;
        visibility: visible;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #059669;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.85rem;
        margin-top: 15px;
    }

    .status-live {
        background: #dcfce7;
        color: #166534;
    }

    .status-historical {
        background: #fffbeb;
        color: #92400e;
    }

    /* Modal styles for download confirmation */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 25px;
        width: 90%;
        max-width: 450px;
        b ox-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 15px;
        color: #1f2937;
    }

    .modal-text {
        margin-bottom: 20px;
        color: #4b5563;
        line-height: 1.5;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-btn-cancel {
        background: #f3f4f6;
        color: #4b5563;
    }

    .modal-btn-cancel:hover {
        background: #e5e7eb;
    }

    .modal-btn-confirm {
        background: #059669;
        color: white;
    }

    .modal-btn-confirm:hover {
        background: #047857;
    }

    @media (max-width: 768px) {
        .visualization-container {
            padding: 15px;
        }

        .page-title {
            font-size: 1.8rem;
        }

        .button-group {
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
            justify-content: center;
        }

        .checkbox-group {
            flex-direction: column;
            gap: 10px;
        }

        .modal-actions {
            flex-direction: column;
        }

        .modal-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="visualization-container">
    <h1 class="page-title">Sensor Data Visualization</h1>

    <!-- Control Panel -->
    <div class="control-panel">
        <!-- Dropdown to select chart type -->
        <div class="control-section">
            <label for="chart-type" class="section-title">Select Chart Type:</label>
            <select id="chart-type" class="chart-type-select">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
                <option value="scatter">Scatter Chart</option>
            </select>
        </div>

        <!-- Time range selection for historical data -->
        <div class="control-section">
            <label for="time-range" class="section-title">Select Time Range:</label>
            <select id="time-range" class="time-range-select">
                <option value="realtime">Real-time Data</option>
                <option value="1">Last Hour</option>
                <option value="6">Last 6 Hours</option>
                <option value="24">Last 24 Hours</option>
                <option value="168">Last Week</option>
                <option value="720">Last Month</option>
            </select>
        </div>

        <!-- Checkboxes to select data types -->
        <div class="control-section">
            <span class="section-title">Select Data Types:</span>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" name="data-type" value="temperature" checked>
                    <span class="checkbox-label">Temperature</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="data-type" value="humidity">
                    <span class="checkbox-label">Humidity</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" name="data-type" value="moisture">
                    <span class="checkbox-label">Moisture</span>
                </label>
            </div>
        </div>

        <!-- Buttons for creating and downloading the chart -->
        <div class="button-group">
            <button id="create-chart" class="action-btn btn-primary">
                <i class="fas fa-chart-line"></i>
                Create Chart
            </button>
            <button id="download-chart" class="action-btn btn-secondary">
                <i class="fas fa-download"></i>
                Download Chart
            </button>
            <button id="toggle-updates" class="action-btn btn-outline">
                <i class="fas fa-pause"></i>
                Pause Updates
            </button>
        </div>

        <div class="status-indicator status-live" id="realtime-status">
            <i class="fas fa-circle"></i>
            Live Data Updates Enabled
        </div>
        <div class="status-indicator status-historical" id="historical-status" style="display: none;">
            <i class="fas fa-history"></i>
            Viewing Historical Data
        </div>
    </div>

    <!-- Chart container -->
    <div class="chart-container">
        <div class="loading-indicator" id="chart-loading">
            <div class="spinner"></div>
            <span style="margin-left: 15px; font-weight: 600;">Loading sensor data...</span>
        </div>
        <canvas id="sensorChart" width="800" height="400"></canvas>
    </div>
</div>

<!-- Download Confirmation Modal -->
<div class="modal-overlay" id="download-modal">
    <div class="modal-content">
        <h3 class="modal-title">Download Chart</h3>
        <p class="modal-text">Are you sure you want to download this chart as an image file? The download will include the current view of the chart with all selected data.</p>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" id="cancel-download">Cancel</button>
            <button class="modal-btn modal-btn-confirm" id="confirm-download">Download</button>
        </div>
    </div>
</div>

<!-- Include Chart.js and date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    // Initialize the chart
    let chart = null;
    const ctx = document.getElementById('sensorChart').getContext('2d');
    let updateInterval = null; // Variable to store the interval for real-time updates
    let isRealTime = true; // Track if we're viewing real-time data
    let currentDataTypes = []; // Track currently selected data types

    // Show loading indicator
    function showLoading() {
        const loadingElement = document.getElementById('chart-loading');
        if (loadingElement) {
            loadingElement.classList.add('visible');
        }
    }

    // Hide loading indicator
    function hideLoading() {
        const loadingElement = document.getElementById('chart-loading');
        if (loadingElement) {
            loadingElement.classList.remove('visible');
        }
    }

    // Show download confirmation modal
    function showDownloadModal() {
        const modal = document.getElementById('download-modal');
        modal.classList.add('visible');
    }

    // Hide download confirmation modal
    function hideDownloadModal() {
        const modal = document.getElementById('download-modal');
        modal.classList.remove('visible');
    }

    // Update status indicators based on data mode
    function updateStatusIndicators() {
        const realtimeStatus = document.getElementById('realtime-status');
        const historicalStatus = document.getElementById('historical-status');

        if (isRealTime) {
            realtimeStatus.style.display = 'flex';
            historicalStatus.style.display = 'none';
        } else {
            realtimeStatus.style.display = 'none';
            historicalStatus.style.display = 'flex';
        }
    }

    // Update toggle button based on update state
    function updateToggleButton(isUpdating) {
        const toggleBtn = document.getElementById('toggle-updates');
        if (isUpdating) {
            toggleBtn.innerHTML = '<i class="fas fa-pause"></i> Pause Updates';
            toggleBtn.classList.remove('btn-outline');
            toggleBtn.classList.add('btn-primary');
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-play"></i> Resume Updates';
            toggleBtn.classList.remove('btn-primary');
            toggleBtn.classList.add('btn-outline');
        }
    }

    // Function to initialize or update the chart
    function initializeChart(dataTypes, chartType, timeRange) {
        console.log("Initializing chart with data types:", dataTypes, "chart type:", chartType, "time range:", timeRange);
        showLoading();

        // Determine if we're viewing real-time or historical data
        isRealTime = timeRange === 'realtime';
        updateStatusIndicators();

        // Destroy the existing chart if it exists
        if (chart) {
            chart.destroy();
            chart = null;
        }

        // Create a new chart
        chart = new Chart(ctx, {
            type: chartType, // Use the selected chart type
            data: {
                labels: [], // Will be populated with timestamps
                datasets: [] // Will be populated with data for each selected type
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: isRealTime ? 'Real-time Sensor Data' : 'Historical Sensor Data',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: '#1f2937'
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#374151',
                        borderColor: '#059669',
                        borderWidth: 1,
                        cornerRadius: 8,
                        padding: 12,
                    },
                    legend: {
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                weight: '600'
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: isRealTime ? 'minute' : 'hour',
                            tooltipFormat: 'MMM dd, yyyy HH:mm:ss',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MMM dd'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time',
                            font: {
                                size: 14,
                                weight: '600'
                            },
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(229, 231, 235, 0.8)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value',
                            font: {
                                size: 14,
                                weight: '600'
                            },
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(229, 231, 235, 0.8)'
                        }
                    }
                }
            }
        });

        console.log("Chart initialized:", chart);

        // Start updates based on data type
        if (isRealTime) {
            startRealTimeUpdates(dataTypes);
            updateToggleButton(true);
        } else {
            // For historical data, fetch once
            updateChart(dataTypes, timeRange);
            updateToggleButton(false);
        }
    }

    // Function to start real-time updates
    function startRealTimeUpdates(dataTypes) {
        // Clear any existing interval
        if (updateInterval) {
            clearInterval(updateInterval);
        }

        // Fetch and update data every 5 seconds
        updateInterval = setInterval(() => {
            updateChart(dataTypes);
        }, 5000); // 5000 milliseconds = 5 seconds

        // Fetch data immediately
        updateChart(dataTypes);
    }

    // Function to stop real-time updates
    function stopRealTimeUpdates() {
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
    }

    // Function to fetch and update chart data
    function updateChart(dataTypes, timeRange = 'realtime') {
        console.log("Fetching data for types:", dataTypes, "time range:", timeRange);

        // Build the API URL with parameters
        let apiUrl = '/irrigation/get-sensor-data/?';
        dataTypes.forEach((type, index) => {
            if (index > 0) apiUrl += '&';
            apiUrl += `type=${type}`;
        });

        // Add time range parameter for historical data
        if (timeRange !== 'realtime') {
            apiUrl += `&hours=${timeRange}`;
        }

        // Fetch data from the API
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data); // Debugging

                if (chart && data) {
                    // Clear existing datasets
                    chart.data.datasets = [];

                    // Add a dataset for each data type
                    Object.keys(data).forEach(type => {
                        if (data[type] && data[type].labels && data[type].values) {
                            // Filter out anomalous data (e.g., 0.0 or null values)
                            const filteredData = data[type].values.map((value, index) => ({
                                x: data[type].labels[index],
                                y: value !== 0.0 ? value : null // Replace 0.0 with null to skip it
                            }));

                            chart.data.datasets.push({
                                label: type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' '),
                                data: filteredData,
                                borderColor: getRandomColor(),
                                backgroundColor: hexToRgba(getRandomColor(), 0.1),
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                fill: true,
                                tension: 0.3
                            });
                        }
                    });

                    // Update the chart
                    chart.update();
                    hideLoading();

                    console.log("Chart updated:", chart); // Debugging
                }
            })
            .catch(error => {
                console.error("Error updating chart:", error); // Debugging
                hideLoading();
            });
    }

    // Function to generate a random color from a predefined palette
    function getRandomColor() {
        const colors = [
            '#FF6B6B', // Red
            '#4ECDC4', // Teal
            '#45B7D1', // Blue
            '#96CEB4', // Green
            '#FFE66D', // Yellow
            '#FF9F1C'  // Orange
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // Convert hex to rgba
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Function to download the chart
    function downloadChart() {
        if (chart) {
            // Convert the chart to a base64 image
            const image = chart.toBase64Image();

            // Create a temporary link element
            const link = document.createElement('a');
            link.href = image;
            link.download = `sensor-data-chart-${new Date().toISOString().slice(0, 10)}.png`;
            link.click(); // Trigger the download

            // Hide the modal after download
            hideDownloadModal();
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Event listener for create chart button
        document.getElementById('create-chart').addEventListener('click', function() {
            const chartType = document.getElementById('chart-type').value;
            const timeRange = document.getElementById('time-range').value;
            const selectedDataTypes = Array.from(document.querySelectorAll('input[name="data-type"]:checked'))
                .map(input => input.value);

            if (selectedDataTypes.length === 0) {
                alert("Please select at least one data type to visualize.");
                return;
            }

            currentDataTypes = selectedDataTypes;
            initializeChart(selectedDataTypes, chartType, timeRange);
        });

        // Event listener for download button - shows confirmation modal
        document.getElementById('download-chart').addEventListener('click', function() {
            if (chart) {
                showDownloadModal();
            } else {
                alert("No chart available to download. Please create a chart first.");
            }
        });

        // Event listener for confirm download button
        document.getElementById('confirm-download').addEventListener('click', downloadChart);

        // Event listener for cancel download button
        document.getElementById('cancel-download').addEventListener('click', hideDownloadModal);

        // Event listener for toggle updates button
        document.getElementById('toggle-updates').addEventListener('click', function() {
            if (isRealTime) {
                if (updateInterval) {
                    stopRealTimeUpdates();
                    updateToggleButton(false);
                } else {
                    startRealTimeUpdates(currentDataTypes);
                    updateToggleButton(true);
                }
            } else {
                alert("Live updates are only available for real-time data. Switch to real-time mode to enable this feature.");
            }
        });

        // Close modal when clicking outside
        document.getElementById('download-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDownloadModal();
            }
        });
    });
</script>
{% endblock %}
